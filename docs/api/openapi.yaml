openapi: 3.0.0
info:
  title: EcoComply API
  version: 1.0.0
  description: |
    Compliance Management SaaS for Environmental Permits
    
    This API provides endpoints for managing environmental compliance, obligations, evidence, and audit packs.
  contact:
    name: EcoComply Support
    email: support@ecocomply.com
  license:
    name: Proprietary
    url: https://ecocomply.com/license

servers:
  - url: http://localhost:3000/api/v1
    description: Development server
  - url: https://api-staging.ecocomply.com/api/v1
    description: Staging server
  - url: https://api.ecocomply.com/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and authorization
  - name: Companies
    description: Company management
  - name: Sites
    description: Site management
  - name: Documents
    description: Document upload and management
  - name: Obligations
    description: Obligation management
  - name: Evidence
    description: Evidence management
  - name: Deadlines
    description: Deadline management
  - name: Schedules
    description: Monitoring schedule management
  - name: Audit Packs
    description: Audit pack generation
  - name: Module 2
    description: Trade Effluent module endpoints
  - name: Module 3
    description: MCPD/Generators module endpoints
  - name: Users
    description: User management
  - name: Background Jobs
    description: Background job status and management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API and its services
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: User signup
      description: Creates a new user account, company, and activates Module 1
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignupResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticates a user and returns access tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me:
    get:
      tags:
        - Users
      summary: Get current user
      description: Returns the currently authenticated user's information
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        services:
          type: object
          properties:
            database:
              type: string
              enum: [healthy, unhealthy]
            redis:
              type: string
              enum: [healthy, unhealthy]
            storage:
              type: string
              enum: [healthy, unhealthy]

    SignupRequest:
      type: object
      required:
        - email
        - password
        - full_name
        - company_name
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        full_name:
          type: string
        company_name:
          type: string

    SignupResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            access_token:
              type: string
            refresh_token:
              type: string
        request_id:
          type: string
          format: uuid

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    LoginResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            access_token:
              type: string
            refresh_token:
              type: string
        request_id:
          type: string
          format: uuid

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        full_name:
          type: string
        company_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [OWNER, ADMIN, STAFF, CONSULTANT, VIEWER]

    UserResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/User'
        request_id:
          type: string
          format: uuid

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        request_id:
          type: string
          format: uuid

