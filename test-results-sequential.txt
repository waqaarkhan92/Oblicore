
> ecocomply@1.0.0 test
> jest --runInBand

[baseline-browser-mapping] The data in this module is over two months old.  To ensure accurate Baseline data, please update: `npm i baseline-browser-mapping@latest -D`
FAIL tests/integration/api/pagination.test.ts (20.887 s)
  ● Pagination API › Companies Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      45 |       });
      46 |
    > 47 |       expect(response.status).toBe(200);
         |                               ^
      48 |       const data = await response.json();
      49 |       expect(data).toHaveProperty('pagination');
      50 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:47:31)

  ● Pagination API › Companies Pagination › should respect limit parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      63 |       });
      64 |
    > 65 |       expect(response.status).toBe(200);
         |                               ^
      66 |       const data = await response.json();
      67 |       expect(data.data.length).toBeLessThanOrEqual(5);
      68 |       expect(data.pagination.limit).toBe(5);

      at Object.toBe (tests/integration/api/pagination.test.ts:65:31)

  ● Pagination API › Companies Pagination › should handle cursor parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      80 |       });
      81 |
    > 82 |       expect(firstResponse.status).toBe(200);
         |                                    ^
      83 |       const firstData = await firstResponse.json();
      84 |
      85 |       if (firstData.pagination?.cursor) {

      at Object.toBe (tests/integration/api/pagination.test.ts:82:36)

  ● Pagination API › Companies Pagination › should enforce max limit of 100

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      105 |       });
      106 |
    > 107 |       expect(response.status).toBe(200);
          |                               ^
      108 |       const data = await response.json();
      109 |       expect(data.pagination.limit).toBeLessThanOrEqual(100);
      110 |     });

      at Object.toBe (tests/integration/api/pagination.test.ts:107:31)

  ● Pagination API › Sites Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      123 |       });
      124 |
    > 125 |       expect(response.status).toBe(200);
          |                               ^
      126 |       const data = await response.json();
      127 |       expect(data).toHaveProperty('pagination');
      128 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:125:31)

  ● Pagination API › Evidence Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      163 |       });
      164 |
    > 165 |       expect(response.status).toBe(200);
          |                               ^
      166 |       const data = await response.json();
      167 |       expect(data).toHaveProperty('pagination');
      168 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:165:31)

FAIL tests/comprehensive/phase-2-api-comprehensive.test.ts (14.493 s)
  ● Phase 2: API Layer - Comprehensive Tests › 2.1: Authentication Endpoints › POST /api/v1/auth/login › should return token for valid credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      130 |         });
      131 |
    > 132 |         expect(response.status).toBe(200);
          |                                 ^
      133 |         const data = await response.json();
      134 |         expect(data.data).toHaveProperty('access_token');
      135 |         expect(data.data).toHaveProperty('refresh_token');

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:132:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.1: Authentication Endpoints › GET /api/v1/auth/me › should return user info with valid token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      160 |         });
      161 |
    > 162 |         expect(response.status).toBe(200);
          |                                 ^
      163 |         const data = await response.json();
      164 |         expect(data.data).toHaveProperty('id');
      165 |         expect(data.data).toHaveProperty('email', testUser.email);

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:162:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › GET /api/v1/companies › should return user company with valid token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      189 |         });
      190 |
    > 191 |         expect(response.status).toBe(200);
          |                                 ^
      192 |         const data = await response.json();
      193 |         expect(data.data).toBeDefined();
      194 |       });

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:191:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › GET /api/v1/sites › should return sites for user company

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      206 |         });
      207 |
    > 208 |         expect(response.status).toBe(200);
          |                                 ^
      209 |         const data = await response.json();
      210 |         expect(Array.isArray(data.data)).toBe(true);
      211 |       });

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:208:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › POST /api/v1/sites › should create site with valid data

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

      233 |         );
      234 |
    > 235 |         expect(response.status).toBe(201);
          |                                 ^
      236 |         const data = await response.json();
      237 |         expect(data.data).toHaveProperty('id');
      238 |         testSite.id = data.data.id;

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:235:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.3: Document Endpoints › should reject document upload without token

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 405

      276 |       // Note: Actual file upload test would need FormData
      277 |       const response = await client.post('/api/v1/documents/upload', {});
    > 278 |       expect(response.status).toBe(401);
          |                               ^
      279 |     });
      280 |   });
      281 |

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:278:31)

  ● Phase 2: API Layer - Comprehensive Tests › 2.5: RLS Enforcement › should prevent User A from seeing User B data

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [403, 404]

      347 |
      348 |       // Should fail (403 or 404) - User A cannot see User B's company
    > 349 |       expect([403, 404]).toContain(response.status);
          |                          ^
      350 |     });
      351 |   });
      352 |

      at Object.toContain (tests/comprehensive/phase-2-api-comprehensive.test.ts:349:26)

  ● Phase 2: API Layer - Comprehensive Tests › 2.6: Rate Limiting › should enforce rate limits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |       // Accept either all OK or some rate limited (if rate limiting is working)
    > 375 |       expect(allOk || someRateLimited).toBe(true);
          |                                        ^
      376 |     });
      377 |   });
      378 |

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:375:40)

  ● Phase 2: API Layer - Comprehensive Tests › 2.7: Error Handling › should return 404 for non-existent resource

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      392 |
      393 |         // Should be 404 (not found) or 401 (unauthorized if token invalid)
    > 394 |         expect([404, 401].includes(response.status)).toBe(true);
          |                                                      ^
      395 |       });
      396 |
      397 |     it('should return 400 for invalid input', async () => {

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:394:54)

  ● Phase 2: API Layer - Comprehensive Tests › 2.7: Error Handling › should return standard error format

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      424 |
      425 |         // Should be 404 (not found) or 401 (unauthorized if token invalid)
    > 426 |         expect([404, 401].includes(response.status)).toBe(true);
          |                                                      ^
      427 |         const data = await response.json();
      428 |         expect(data.error).toBeDefined();
      429 |         expect(data.error).toHaveProperty('code');

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:426:54)

FAIL tests/integration/api/rls-enforcement.test.ts (22.03 s)
  ● RLS Enforcement via API › Companies RLS › should only return User A's company

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      11 |   let userB: { email: string; token?: string; company_id: string };
      12 |
    > 13 |   beforeEach(async () => {
         |   ^
      14 |     // Create User A in Company A
      15 |     userA = await client.signup(
      16 |       `user_a_${Date.now()}@example.com`,

      at beforeEach (tests/integration/api/rls-enforcement.test.ts:13:3)
      at Object.describe (tests/integration/api/rls-enforcement.test.ts:8:1)

  ● RLS Enforcement via API › Companies RLS › should only return User B's company

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      64 |       });
      65 |
    > 66 |       expect(response.status).toBe(200);
         |                               ^
      67 |       const data = await response.json();
      68 |       expect(Array.isArray(data.data)).toBe(true);
      69 |       

      at Object.toBe (tests/integration/api/rls-enforcement.test.ts:66:31)

  ● RLS Enforcement via API › Companies RLS › should prevent User A from seeing User B's company

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [401, 403, 404]

      82 |
      83 |       // Should return 401, 403, or 404 (unauthorized, forbidden, or not found)
    > 84 |       expect([401, 403, 404]).toContain(response.status);
         |                               ^
      85 |     });
      86 |   });
      87 |

      at Object.toContain (tests/integration/api/rls-enforcement.test.ts:84:31)

  ● RLS Enforcement via API › Sites RLS › should only return User A's sites

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"11e0ed18-6f11-4629-bfbe-e1fd1ebb2297","timestamp":"2025-11-30T15:46:46.186Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

  ● RLS Enforcement via API › Sites RLS › should prevent User A from accessing User B's site

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"989b3c46-33e6-4616-9ab6-4d3a947f6d3f","timestamp":"2025-11-30T15:46:49.811Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:22:13)

  ● RLS Enforcement via API › Users RLS › should only return users from User A's company (Owner/Admin only)

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"59c2d418-e9f2-426e-beae-474f2a06406b","timestamp":"2025-11-30T15:46:51.016Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

  ● RLS Enforcement via API › Users RLS › should prevent User A from accessing User B's user record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"31ca25ad-b0b4-4097-9180-b8803a3fad6b","timestamp":"2025-11-30T15:46:52.186Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

FAIL tests/integration/api/documents.test.ts (8.439 s)
  ● Documents API › POST /api/v1/documents › should upload document with valid file

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"801e1a3d-40da-42bc-a389-6979cd9f6f98","timestamp":"2025-11-30T15:46:53.389Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › POST /api/v1/documents › should reject upload without file

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"6f834331-9366-4524-8ccb-e658080118fe","timestamp":"2025-11-30T15:46:54.541Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › POST /api/v1/documents › should reject upload without site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"cca52cb9-f903-4ec3-a2d3-f49ffb9fc036","timestamp":"2025-11-30T15:46:55.725Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › GET /api/v1/documents › should filter by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3bad0167-3b40-4c90-a08b-d57f74367f96","timestamp":"2025-11-30T15:46:59.499Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › GET /api/v1/documents/{id} › should return 404 for non-existent document

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"d098f684-8a3a-4006-ac19-144845ac7ddd","timestamp":"2025-11-30T15:47:00.630Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

FAIL tests/integration/api/rate-limiting.test.ts
  ● Rate Limiting API › Rate Limit Headers › should include rate limit headers in response

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"0e81828e-a385-4a66-9132-47e960bc47db","timestamp":"2025-11-30T15:47:01.824Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Rate Limit Headers › should decrease remaining count

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"f1fddc69-f3d6-4171-ae83-d4f1abcab107","timestamp":"2025-11-30T15:47:03.012Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Rate Limit Enforcement › should eventually return 429 when limit exceeded

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"ec9af56b-441c-4ecc-82ce-d535b0ccf483","timestamp":"2025-11-30T15:47:04.172Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Different Endpoint Limits › should have different limits for document upload

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"285d95fd-397a-4191-b272-acfdda9bae23","timestamp":"2025-11-30T15:47:05.343Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

FAIL tests/integration/api/error-handling.test.ts
  ● Error Handling API › 403 Forbidden › should return 403 or 404 when accessing other company's data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"fe2c7ec7-ab19-4278-a0ca-4a47655cb1d4","timestamp":"2025-11-30T15:47:06.586Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/error-handling.test.ts:64:15)

  ● Error Handling API › 404 Not Found › should return 404 for non-existent obligation

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 400

      106 |       });
      107 |
    > 108 |       expect(response.status).toBe(404);
          |                               ^
      109 |       const data = await response.json();
      110 |       expect(data.error).toBeDefined();
      111 |       expect(data.error.code).toBe('NOT_FOUND');

      at Object.toBe (tests/integration/api/error-handling.test.ts:108:31)

  ● Error Handling API › 404 Not Found › should return 404 for non-existent document

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"1729bdc7-a555-4b7c-82bc-7016e40e73f8","timestamp":"2025-11-30T15:47:10.152Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/error-handling.test.ts:96:27)

FAIL tests/integration/api/module-3.test.ts
  ● Module 3 API Endpoints › Module Activation › should return 403 if Module 3 not activated

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should list generators

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should filter generators by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should include percentage calculations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should create a generator

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 400 for invalid generator_type

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 404 for invalid document_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators/{generatorId} › should get generator details

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators/{generatorId} › should return 404 for invalid generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › PUT /api/v1/module-3/generators/{generatorId} › should update generator

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should create a run-hour record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should calculate running totals correctly

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should return 400 for negative hours

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should return 404 for invalid generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should list run-hour records

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should filter run-hours by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should filter run-hours by date range

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours/{recordId} › should get run-hour record details

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › PUT /api/v1/module-3/run-hours/{recordId} › should update run-hour record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/stack-tests › should create a stack test

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/stack-tests › should return 400 for invalid compliance_status

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/stack-tests › should list stack tests

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/stack-tests › should filter stack tests by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/maintenance-records › should create a maintenance record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/maintenance-records › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/maintenance-records › should list maintenance records

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/maintenance-records › should filter maintenance records by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations › should list MCPD registrations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations › should filter registrations by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations/{registrationId} › should get registration details with generators

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/aer › should list AER documents

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should create AER document and queue generation

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should return 404 for invalid document_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should enforce RLS - users can only see their company data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should require authentication

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should require appropriate role for mutations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

FAIL tests/integration/api/consultant.test.ts
  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should return consultant dashboard with aggregated data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should return empty dashboard if no clients assigned

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should require CONSULTANT role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients › should return list of assigned clients

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients › should filter by status

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients/{clientId} › should return client details for assigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients/{clientId} › should return 403 for unassigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should generate pack for assigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should reject Board Pack generation

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should require ACTIVE assignment

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should validate required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should assign consultant to company

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should assign consultant to company

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should require OWNER or ADMIN role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should require OWNER or ADMIN role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate consultant exists

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate consultant exists

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate user is a consultant

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate user is a consultant

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

FAIL tests/comprehensive/phase-1-database-comprehensive.test.ts
  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all 36+ required tables

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      15 |         .eq('table_type', 'BASE TABLE');
      16 |
    > 17 |       expect(error).toBeNull();
         |                     ^
      18 |       expect(tables).toBeDefined();
      19 |       
      20 |       const tableNames = tables?.map(t => t.table_name) || [];

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:17:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all required columns in companies table

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.notifications'", "message": "Could not find the table 'public.information_schema.columns' in the schema cache"}

      64 |         .eq('table_name', 'companies');
      65 |
    > 66 |       expect(error).toBeNull();
         |                     ^
      67 |       const columnNames = columns?.map(c => c.column_name) || [];
      68 |       
      69 |       expect(columnNames).toContain('id');

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:66:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all required indexes

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      92 |       
      93 |       // Check for critical indexes
    > 94 |       expect(indexNames.some((name: string) => name.includes('companies_stripe'))).toBe(true);
         |                                                                                    ^
      95 |       expect(indexNames.some((name: string) => name.includes('users_company'))).toBe(true);
      96 |       expect(indexNames.some((name: string) => name.includes('sites_company'))).toBe(true);
      97 |       expect(indexNames.some((name: string) => name.includes('obligations_document'))).toBe(true);

      at Object.toBe (tests/comprehensive/phase-1-database-comprehensive.test.ts:94:84)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.3: RLS Policies › should have policies for SELECT, INSERT, UPDATE, DELETE on tenant tables

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.companies'", "message": "Could not find the table 'public.pg_policies' in the schema cache"}

      220 |         .eq('schemaname', 'public');
      221 |
    > 222 |       expect(error).toBeNull();
          |                     ^
      223 |       
      224 |       const companiesPolicies = policies?.filter((p: any) => p.tablename === 'companies') || [];
      225 |       

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:222:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.5: Seed Data › should have correct module prerequisites

    expect(received).toBe(expected) // Object.is equality

    Expected: undefined
    Received: "c24c3828-a6a2-4f56-88ea-e86be8706af4"

      333 |       
      334 |       // Module 2 and 3 should require Module 1
    > 335 |       expect(module2?.requires_module_id).toBe(module1?.id);
          |                                           ^
      336 |       expect(module3?.requires_module_id).toBe(module1?.id);
      337 |     });
      338 |   });

      at Object.toBe (tests/comprehensive/phase-1-database-comprehensive.test.ts:335:43)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.6: Helper Functions › should have RLS helper functions

    expect(received).not.toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      349 |       // Function should exist (error would be function doesn't exist)
      350 |       // Result doesn't matter, just that function exists
    > 351 |       expect(error?.message).not.toContain('function');
          |                                  ^
      352 |     });
      353 |   });
      354 | });

      at Object.toContain (tests/comprehensive/phase-1-database-comprehensive.test.ts:351:34)

FAIL tests/security/rls-production.test.ts
  ● Console

    console.log
      Rate limited requests: 0

      at Object.log (tests/security/rls-production.test.ts:210:15)

  ● Production Security Audit › RLS Policies › RLS policies prevent cross-tenant access

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 422

      31 |       // Signup User 1
      32 |       const signup1Response = await client.post('/api/v1/auth/signup', user1);
    > 33 |       expect(signup1Response.status).toBe(201);
         |                                      ^
      34 |       const signup1Data = await signup1Response.json();
      35 |       const user1Token = signup1Data.data.access_token || signup1Data.data.token;
      36 |       

      at Object.toBe (tests/security/rls-production.test.ts:33:38)

  ● Production Security Audit › Authentication › JWT tokens cannot be tampered with

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 422

      104 |       
      105 |       const signupResponse = await client.post('/api/v1/auth/signup', testUser);
    > 106 |       expect(signupResponse.status).toBe(201);
          |                                     ^
      107 |       const signupData = await signupResponse.json();
      108 |       const validToken = signupData.data.access_token || signupData.data.token;
      109 |       

      at Object.toBe (tests/security/rls-production.test.ts:106:37)

  ● Production Security Audit › SQL Injection Prevention › SQL injection attempts are prevented

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 400, 404]

      163 |         
      164 |         // Should return 400 or 200 with filtered results (not execute SQL)
    > 165 |         expect([200, 400, 404]).toContain(response.status);
          |                                 ^
      166 |       }
      167 |     });
      168 |   });

      at Object.toContain (tests/security/rls-production.test.ts:165:33)

FAIL tests/integration/api/module-2.test.ts
  ● Console

    console.error
      Site creation failed: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      102 |     if (!siteResponse.ok) {
      103 |       const errorText = await siteResponse.text();
    > 104 |       console.error('Site creation failed:', errorText);
          |               ^
      105 |       throw new Error(`Failed to create test site: ${errorText}`);
      106 |     }
      107 |     

      at Object.error (tests/integration/api/module-2.test.ts:104:15)

  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should list parameters

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should filter parameters by site_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should return 403 if Module 2 not activated

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should create a lab result

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should detect exceedance when limit exceeded

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should return 400 for missing required fields

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should return 404 for invalid parameter_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should list lab results

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should filter lab results by parameter_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should filter lab results by is_exceedance

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results/{resultId} › should get lab result details

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results/{resultId} › should return 400 or 404 for invalid resultId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should list exceedances

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should filter exceedances by threshold

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should include threshold_level in response

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents › should list consents

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents › should filter consents by site_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents/{consentId} › should get consent details with parameters

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents/{consentId} › should return 400 or 404 for invalid consentId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes › should list discharge volumes

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes › should filter discharge volumes by document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should create a discharge volume record

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should return 400 for missing required fields

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should return 400 for negative volume

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes/{volumeId} › should get discharge volume details

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes/{volumeId} › should return 400 or 404 for invalid volumeId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should queue report generation

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should return 400 for missing document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should return 404 for invalid document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/water-company-reports/{reportId} › should get report status

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/water-company-reports/{reportId} › should return 400 or 404 for invalid reportId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

FAIL tests/integration/jobs/excel-import.test.ts
  ● Excel Import Processing Job › should validate Excel file and create preview (Phase 1)

    Failed to upload test Excel: mime type application/octet-stream is not supported

      103 |
      104 |     if (uploadError) {
    > 105 |       throw new Error(`Failed to upload test Excel: ${uploadError.message}`);
          |             ^
      106 |     }
      107 |
      108 |     // Create excel_imports record

      at Object.<anonymous> (tests/integration/jobs/excel-import.test.ts:105:13)

FAIL tests/integration/jobs/deadline-alert.test.ts
  ● Deadline Alert Job › should create notifications for deadlines due in 7/3/1 days

    Failed to create test obligation: null value in column "document_id" of relation "obligations" violates not-null constraint

      94 |
      95 |     if (obligError || !obligation) {
    > 96 |       throw new Error(`Failed to create test obligation: ${obligError?.message}`);
         |             ^
      97 |     }
      98 |
      99 |     // Create deadline due in 7 days

      at Object.<anonymous> (tests/integration/jobs/deadline-alert.test.ts:96:13)

FAIL tests/integration/jobs/monitoring-schedule.test.ts
  ● Monitoring Schedule Job › should calculate deadlines for obligations with frequency

    Failed to create test obligation: null value in column "document_id" of relation "obligations" violates not-null constraint

       96 |
       97 |     if (obligError || !obligation) {
    >  98 |       throw new Error(`Failed to create test obligation: ${obligError?.message}`);
          |             ^
       99 |     }
      100 |
      101 |     // Enqueue job

      at Object.<anonymous> (tests/integration/jobs/monitoring-schedule.test.ts:98:13)

FAIL tests/comprehensive/phase-4-jobs-comprehensive.test.ts
  ● Phase 4: Background Jobs - Comprehensive Tests › 4.1: Queue Manager › should have queue manager configured

    expect(received).toBeDefined()

    Received: undefined

       9 |   describe('4.1: Queue Manager', () => {
      10 |     it('should have queue manager configured', () => {
    > 11 |       expect(QueueManager).toBeDefined();
         |                            ^
      12 |     });
      13 |
      14 |     it('should have all required queues', () => {

      at Object.toBeDefined (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:11:28)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.1: Queue Manager › should have all required queues

    expect(received).toBeDefined()

    Received: undefined

      35 |
      36 |       // Verify queue manager can handle these queues
    > 37 |       expect(QueueManager).toBeDefined();
         |                            ^
      38 |     });
      39 |   });
      40 |

      at Object.toBeDefined (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:37:28)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.2: Job Types › should have document processing job

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at tests/comprehensive/phase-4-jobs-comprehensive.test.ts:43:44
      at Object.<anonymous> (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:43:38)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.3: Worker System › should have worker manager configured

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at Object.<anonymous> (lib/workers/worker-manager.ts:28:32)
      at tests/comprehensive/phase-4-jobs-comprehensive.test.ts:70:57
      at Object.<anonymous> (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:70:51)

FAIL tests/integration/jobs/pack-generation.test.ts
  ● Pack Generation Job › should generate an audit pack PDF

    Failed to create test pack: Could not find the 'status' column of 'audit_packs' in the schema cache

      64 |
      65 |     if (packError || !pack) {
    > 66 |       throw new Error(`Failed to create test pack: ${packError?.message}`);
         |             ^
      67 |     }
      68 |
      69 |     // Enqueue job

      at Object.<anonymous> (tests/integration/jobs/pack-generation.test.ts:66:13)

FAIL tests/frontend/components/button.test.tsx
  ● Button Component › should render button with text

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

       9 | describe('Button Component', () => {
      10 |   it('should render button with text', () => {
    > 11 |     render(<Button>Click me</Button>);
         |           ^
      12 |     expect(screen.getByRole('button', { name: /click me/i })).toBeInTheDocument();
      13 |   });
      14 |

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:11:11)

  ● Button Component › should render button with text

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should handle click events

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      15 |   it('should handle click events', async () => {
      16 |     const handleClick = jest.fn();
    > 17 |     const user = userEvent.setup();
         |                            ^
      18 |     
      19 |     render(<Button onClick={handleClick}>Click me</Button>);
      20 |     

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/components/button.test.tsx:17:28)

  ● Button Component › should handle click events

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should be disabled when disabled prop is true

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      26 |
      27 |   it('should be disabled when disabled prop is true', () => {
    > 28 |     render(<Button disabled>Disabled Button</Button>);
         |           ^
      29 |     
      30 |     const button = screen.getByRole('button', { name: /disabled button/i });
      31 |     expect(button).toBeDisabled();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:28:11)

  ● Button Component › should be disabled when disabled prop is true

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should apply primary variant styles

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      33 |
      34 |   it('should apply primary variant styles', () => {
    > 35 |     render(<Button variant="primary">Primary</Button>);
         |           ^
      36 |     
      37 |     const button = screen.getByRole('button', { name: /primary/i });
      38 |     expect(button).toHaveClass('bg-primary');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:35:11)

  ● Button Component › should apply primary variant styles

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should apply danger variant styles

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      40 |
      41 |   it('should apply danger variant styles', () => {
    > 42 |     render(<Button variant="danger">Danger</Button>);
         |           ^
      43 |     
      44 |     const button = screen.getByRole('button', { name: /danger/i });
      45 |     expect(button).toHaveClass('bg-danger');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:42:11)

  ● Button Component › should apply danger variant styles

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at detachClipboardStubFromView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:122:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:161:20)

FAIL tests/comprehensive/phase-3-ai-comprehensive.test.ts
  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.2: Rule Library Integration › should have rule library patterns in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.module_activations'", "message": "Could not find the table 'public.rule_library_patterns' in the schema cache"}

      28 |
      29 |       // Patterns may or may not exist - this is OK
    > 30 |       expect(error).toBeNull();
         |                     ^
      31 |     });
      32 |
      33 |     it('should have pattern matching function', async () => {

      at Object.toBeNull (tests/comprehensive/phase-3-ai-comprehensive.test.ts:30:21)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.3: Document Processing › should have document processor configured

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      40 |   describe('3.3: Document Processing', () => {
      41 |     it('should have document processor configured', async () => {
    > 42 |       const { DocumentProcessor } = await import('../../lib/ai/document-processor');
         |                                           ^
      43 |       expect(DocumentProcessor).toBeDefined();
      44 |     });
      45 |

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at tests/comprehensive/phase-3-ai-comprehensive.test.ts:42:43
      at Object.<anonymous> (tests/comprehensive/phase-3-ai-comprehensive.test.ts:42:37)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.5: Cost Tracking › should have cost calculator configured

    expect(received).toBeDefined()

    Received: undefined

      61 |     it('should have cost calculator configured', async () => {
      62 |       const { CostCalculator } = await import('../../lib/ai/cost-calculator');
    > 63 |       expect(CostCalculator).toBeDefined();
         |                              ^
      64 |     });
      65 |
      66 |     it('should track extraction costs in database', async () => {

      at Object.toBeDefined (tests/comprehensive/phase-3-ai-comprehensive.test.ts:63:30)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.5: Cost Tracking › should track extraction costs in database

    expect(received).toBeNull()

    Received: {"code": "42703", "details": null, "hint": null, "message": "column extraction_logs.cost_per_1k_tokens does not exist"}

      71 |
      72 |       // Logs may or may not exist - this is OK
    > 73 |       expect(error).toBeNull();
         |                     ^
      74 |     });
      75 |   });
      76 | });

      at Object.toBeNull (tests/comprehensive/phase-3-ai-comprehensive.test.ts:73:21)

FAIL tests/frontend/dashboard/obligations-list.test.tsx
  ● Obligations List Page › should render obligations list page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      39 |     });
      40 |
    > 41 |     render(<ObligationsPage />);
         |           ^
      42 |     
      43 |     expect(screen.getByText('Obligations')).toBeInTheDocument();
      44 |     expect(screen.getByText(/track and manage your compliance obligations/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:41:11)

  ● Obligations List Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      52 |     });
      53 |
    > 54 |     render(<ObligationsPage />);
         |           ^
      55 |     
      56 |     expect(screen.getByText(/loading obligations/i)).toBeInTheDocument();
      57 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:54:11)

  ● Obligations List Page › should show empty state when no obligations

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      64 |     });
      65 |
    > 66 |     render(<ObligationsPage />);
         |           ^
      67 |     
      68 |     expect(screen.getByText(/no obligations found/i)).toBeInTheDocument();
      69 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:66:11)

  ● Obligations List Page › should render obligations table when data exists

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      89 |     });
      90 |
    > 91 |     render(<ObligationsPage />);
         |           ^
      92 |     
      93 |     expect(screen.getByText('Test Obligation')).toBeInTheDocument();
      94 |     expect(screen.getByText('Obligation')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:91:11)

  ● Obligations List Page › should show error state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      104 |     });
      105 |
    > 106 |     render(<ObligationsPage />);
          |           ^
      107 |     
      108 |     expect(screen.getByText(/error loading obligations/i)).toBeInTheDocument();
      109 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:106:11)

FAIL tests/comprehensive/phase-8-modules-comprehensive.test.ts
  ● Phase 8: Module Extensions - Comprehensive Tests › 8.1: Module 2 - Trade Effluent › should have Module 2 tables in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      23 |
      24 |       // At least some Module 2 tables should exist
    > 25 |       expect(error).toBeNull();
         |                     ^
      26 |     });
      27 |
      28 |     it('should have Module 2 API endpoints', () => {

      at Object.toBeNull (tests/comprehensive/phase-8-modules-comprehensive.test.ts:25:21)

  ● Phase 8: Module Extensions - Comprehensive Tests › 8.2: Module 3 - MCPD/Generators › should have Module 3 tables in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      63 |
      64 |       // At least some Module 3 tables should exist
    > 65 |       expect(error).toBeNull();
         |                     ^
      66 |     });
      67 |
      68 |     it('should have Module 3 API endpoints', () => {

      at Object.toBeNull (tests/comprehensive/phase-8-modules-comprehensive.test.ts:65:21)

FAIL tests/frontend/auth/login.test.tsx
  ● Login Page › should render login form

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      38 |
      39 |   it('should render login form', () => {
    > 40 |     render(<LoginPage />);
         |           ^
      41 |     
      42 |     expect(screen.getByText('EcoComply')).toBeInTheDocument();
      43 |     expect(screen.getByText('Sign in to your account')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/login.test.tsx:40:11)

  ● Login Page › should render login form

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should show validation error for empty email

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      48 |
      49 |   it('should show validation error for empty email', async () => {
    > 50 |     const user = userEvent.setup();
         |                            ^
      51 |     render(<LoginPage />);
      52 |     
      53 |     const submitButton = screen.getByRole('button', { name: /sign in/i });

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/auth/login.test.tsx:50:28)

  ● Login Page › should show validation error for empty email

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should show validation error for empty password

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      60 |
      61 |   it('should show validation error for empty password', async () => {
    > 62 |     const user = userEvent.setup();
         |                            ^
      63 |     render(<LoginPage />);
      64 |     
      65 |     const emailInput = screen.getByLabelText('Email');

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/auth/login.test.tsx:62:28)

  ● Login Page › should show validation error for empty password

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should have link to signup page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      75 |
      76 |   it('should have link to signup page', () => {
    > 77 |     render(<LoginPage />);
         |           ^
      78 |     
      79 |     const signupLink = screen.getByRole('link', { name: /sign up/i });
      80 |     expect(signupLink).toHaveAttribute('href', '/signup');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/login.test.tsx:77:11)

  ● Login Page › should have link to signup page

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at detachClipboardStubFromView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:122:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:161:20)

FAIL tests/frontend/auth/signup.test.tsx
  ● Signup Page › should render signup form

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      37 |
      38 |   it('should render signup form', () => {
    > 39 |     render(<SignupPage />);
         |           ^
      40 |     
      41 |     expect(screen.getByRole('heading', { name: /create account/i })).toBeInTheDocument();
      42 |     expect(screen.getByText('Get started with EcoComply')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:39:11)

  ● Signup Page › should show password requirements

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      50 |
      51 |   it('should show password requirements', () => {
    > 52 |     render(<SignupPage />);
         |           ^
      53 |     
      54 |     expect(screen.getByText(/must be at least 8 characters/i)).toBeInTheDocument();
      55 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:52:11)

  ● Signup Page › should have link to login page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      56 |
      57 |   it('should have link to login page', () => {
    > 58 |     render(<SignupPage />);
         |           ^
      59 |     
      60 |     const loginLink = screen.getByRole('link', { name: /sign in/i });
      61 |     expect(loginLink).toHaveAttribute('href', '/login');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:58:11)

FAIL tests/frontend/dashboard/documents-list.test.tsx
  ● Documents List Page › should render documents list page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      39 |     });
      40 |
    > 41 |     render(<DocumentsPage />);
         |           ^
      42 |     
      43 |     expect(screen.getByText('Documents')).toBeInTheDocument();
      44 |     expect(screen.getByText(/manage your environmental compliance documents/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:41:11)

  ● Documents List Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      52 |     });
      53 |
    > 54 |     render(<DocumentsPage />);
         |           ^
      55 |     
      56 |     expect(screen.getByText(/loading documents/i)).toBeInTheDocument();
      57 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:54:11)

  ● Documents List Page › should show empty state when no documents

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      64 |     });
      65 |
    > 66 |     render(<DocumentsPage />);
         |           ^
      67 |     
      68 |     expect(screen.getByText(/no documents found/i)).toBeInTheDocument();
      69 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:66:11)

  ● Documents List Page › should render documents table when data exists

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      88 |     });
      89 |
    > 90 |     render(<DocumentsPage />);
         |           ^
      91 |     
      92 |     expect(screen.getByText('Test Document')).toBeInTheDocument();
      93 |     expect(screen.getByText('Document Name')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:90:11)

  ● Documents List Page › should show error state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      104 |     });
      105 |
    > 106 |     render(<DocumentsPage />);
          |           ^
      107 |     
      108 |     expect(screen.getByText(/error loading documents/i)).toBeInTheDocument();
      109 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:106:11)

  ● Documents List Page › should have upload button

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      116 |     });
      117 |
    > 118 |     render(<DocumentsPage />);
          |           ^
      119 |     
      120 |     const uploadLink = screen.getByRole('link', { name: /upload document/i });
      121 |     expect(uploadLink).toHaveAttribute('href', '/dashboard/documents/upload');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:118:11)

FAIL tests/frontend/dashboard/dashboard-home.test.tsx
  ● Dashboard Home Page › should render dashboard home page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      43 |       });
      44 |
    > 45 |     render(<DashboardPage />);
         |           ^
      46 |     
      47 |     expect(screen.getByText('Dashboard')).toBeInTheDocument();
      48 |     expect(screen.getByText(/welcome back/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:45:11)

  ● Dashboard Home Page › should show stats cards

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      65 |       });
      66 |
    > 67 |     render(<DashboardPage />);
         |           ^
      68 |     
      69 |     expect(screen.getByText('Total Obligations')).toBeInTheDocument();
      70 |     expect(screen.getByText('Overdue')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:67:11)

  ● Dashboard Home Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      84 |       });
      85 |
    > 86 |     render(<DashboardPage />);
         |           ^
      87 |     
      88 |     // Loading states are shown via skeleton/placeholder
      89 |     expect(screen.getByText('Dashboard')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:86:11)

FAIL tests/frontend/dashboard/layout.test.tsx
  ● Dashboard Layout › should redirect to login if not authenticated

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      42 |     mockIsAuthenticated.mockReturnValue(false);
      43 |     
    > 44 |     render(
         |           ^
      45 |       <DashboardLayout>
      46 |         <div>Test Content</div>
      47 |       </DashboardLayout>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/layout.test.tsx:44:11)

  ● Dashboard Layout › should render layout when authenticated

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      54 |     mockIsAuthenticated.mockReturnValue(true);
      55 |     
    > 56 |     render(
         |           ^
      57 |       <DashboardLayout>
      58 |         <div data-testid="content">Test Content</div>
      59 |       </DashboardLayout>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/layout.test.tsx:56:11)

PASS tests/integration/ai/phase3-1.test.ts (6.932 s)
PASS tests/integration/ai/phase3-2-rule-library.test.ts
  ● Console

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:50:7)

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at RuleLibraryMatcher.findMatches (lib/ai/rule-library-matcher.ts:220:5)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:54:23)

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at RuleLibraryMatcher.findMatches (lib/ai/rule-library-matcher.ts:220:5)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:68:23)

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at RuleLibraryMatcher.findMatches (lib/ai/rule-library-matcher.ts:220:5)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:80:23)

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at RuleLibraryMatcher.findMatches (lib/ai/rule-library-matcher.ts:220:5)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:94:23)

    console.error
      Error loading rule library patterns: {
        code: 'PGRST205',
        details: null,
        hint: "Perhaps you meant the table 'public.module_activations'",
        message: "Could not find the table 'public.rule_library_patterns' in the schema cache"
      }

      143 |
      144 |       if (error) {
    > 145 |         console.error('Error loading rule library patterns:', error);
          |                 ^
      146 |         this.patterns = [];
      147 |         return;
      148 |       }

      at RuleLibraryMatcher.error [as loadPatterns] (lib/ai/rule-library-matcher.ts:145:17)
      at RuleLibraryMatcher.findMatches (lib/ai/rule-library-matcher.ts:220:5)
      at Object.<anonymous> (tests/integration/ai/phase3-2-rule-library.test.ts:108:23)

PASS tests/integration/api/health.test.ts
PASS tests/integration/jobs/queue-manager.test.ts
PASS tests/comprehensive/phase-6-features-comprehensive.test.ts
PASS tests/comprehensive/phase-5-frontend-comprehensive.test.ts
PASS tests/comprehensive/phase-7-integration-comprehensive.test.ts
PASS tests/integration/jobs/job-functions.test.ts
FAIL tests/integration/jobs/document-processing.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at Object.<anonymous> (tests/integration/jobs/document-processing.test.ts:10:32)

FAIL tests/integration/api/auth.test.ts
  ● Test suite failed to run

      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:252:1]
     [2m249[0m |       await new Promise(resolve => setTimeout(resolve, 2000));
     [2m250[0m |     }, 15000); // Increase timeout to 15 seconds
     [2m251[0m |       
     [2m252[0m |       const loginResponse = await client.post('/api/v1/auth/login', {
         : [35;1m                            ^^^^^[0m
     [2m253[0m |         email: authenticatedUser.email,
     [2m254[0m |         password: 'TestPassword123!',
     [2m255[0m |       });
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:258:1]
     [2m255[0m |       });
     [2m256[0m |       
     [2m257[0m |       if (loginResponse.ok) {
     [2m258[0m |         const loginData = await loginResponse.json();
         : [35;1m                          ^^^^^[0m
     [2m259[0m |         authenticatedUser.refreshToken = loginData.data?.refresh_token;
     [2m260[0m |         authenticatedUser.token = loginData.data?.access_token || authenticatedUser.token;
     [2m261[0m |       } else {
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:264:1]
     [2m261[0m |       } else {
     [2m262[0m |         // If login fails, try to get refresh token from signup response
     [2m263[0m |         // Signup might have returned tokens if email verification is disabled
     [2m264[0m |         const signupResponse = await client.post('/api/v1/auth/signup', {
         : [35;1m                               ^^^^^[0m
     [2m265[0m |           email: `test_refresh_${Date.now()}@example.com`,
     [2m266[0m |           password: 'TestPassword123!',
     [2m267[0m |           full_name: 'Test User',
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:271:1]
     [2m268[0m |           company_name: 'Test Company',
     [2m269[0m |         });
     [2m270[0m |         if (signupResponse.ok) {
     [2m271[0m |           const signupData = await signupResponse.json();
         : [35;1m                             ^^^^^[0m
     [2m272[0m |           authenticatedUser.refreshToken = signupData.data?.refresh_token;
     [2m273[0m |           authenticatedUser.token = signupData.data?.access_token;
     [2m274[0m |         }
         `----
      [31mx[0m Expression expected
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:359:1]
     [2m356[0m |       expect(data.data).toHaveProperty('message');
     [2m357[0m |     });
     [2m358[0m |   });
     [2m359[0m | });
         : [35;1m^[0m
     [2m360[0m | 
         `----


    Caused by:
        Syntax Error

      at Object.transformSync (node_modules/next/src/build/swc/index.ts:1444:25)
      at transformSync (node_modules/next/src/build/swc/index.ts:1575:19)
      at Object.process (node_modules/next/src/build/swc/jest-transformer.ts:105:25)
      at ScriptTransformer.transformSource (node_modules/@jest/transform/build/index.js:422:31)
      at ScriptTransformer._transformAndBuildScript (node_modules/@jest/transform/build/index.js:519:40)
      at ScriptTransformer.transform (node_modules/@jest/transform/build/index.js:558:19)

FAIL tests/integration/ai/phase3-end-to-end.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      10 | import { getDocumentProcessor } from '@/lib/ai/document-processor';
      11 | import { getObligationCreator } from '@/lib/ai/obligation-creator';
    > 12 | import { getPromptTemplate } from '@/lib/ai/prompts';
         |                            ^
      13 |
      14 | describe('Phase 3: End-to-End AI/Extraction Pipeline', () => {
      15 |   const apiKeyManager = getAPIKeyManager();

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (tests/integration/ai/phase3-end-to-end.test.ts:12:28)

FAIL tests/integration/ai/phase3-3-document-processing.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

       7 | import { getDocumentProcessor } from '@/lib/ai/document-processor';
       8 | import { getObligationCreator } from '@/lib/ai/obligation-creator';
    >  9 | import { createClient } from '@supabase/supabase-js';
         |                            ^
      10 | import { env } from '@/lib/env';
      11 |
      12 | describe('Phase 3.3: Document Processing Pipeline', () => {

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (tests/integration/ai/phase3-3-document-processing.test.ts:9:28)

FAIL tests/frontend/dashboard/documents-upload.test.tsx
  ● Test suite failed to run

    ReferenceError: TextEncoder is not defined

      1 | // Polyfill fetch for Node.js test environment
      2 | if (typeof globalThis.fetch === 'undefined') {
    > 3 |   const { fetch, Request, Response, Headers } = require('undici');
        |                                                 ^
      4 |   globalThis.fetch = fetch;
      5 |   globalThis.Request = Request;
      6 |   globalThis.Response = Response;

      at Object.<anonymous> (node_modules/undici/lib/web/fetch/data-url.js:5:17)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/util.js:7:97)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/headers.js:11:5)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/response.js:3:90)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/index.js:12:5)
      at Object.<anonymous> (node_modules/undici/index.js:119:19)
      at Object.require (jest.setup.js:3:49)

FAIL tests/performance/page-load.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Page Load Performance', () => {
         |      ^
       9 |   const baseURL = process.env.BASE_URL || 'http://localhost:3000';
      10 |
      11 |   test('Page load times < 3s for all pages', async ({ page }) => {

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/performance/page-load.test.ts:8:6)

FAIL tests/performance/api-benchmark.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/tests/performance/api-benchmark.test.ts:11
        const client = new _testclient.TestClient();
              ^

    SyntaxError: Identifier 'client' has already been declared

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)

FAIL tests/e2e/user-journey.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Complete User Journey', () => {
         |      ^
       9 |   const timestamp = Date.now();
      10 |   const testUser = {
      11 |     email: `e2e_test_${timestamp}@example.com`,

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/user-journey.test.ts:8:6)

FAIL tests/e2e/production-readiness.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       7 | import { TestClient } from '../helpers/test-client';
       8 |
    >  9 | test.describe('Production Readiness', () => {
         |      ^
      10 |   const client = new TestClient();
      11 |   const baseURL = process.env.BASE_URL || 'http://localhost:3000';
      12 |

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/production-readiness.test.ts:9:6)

FAIL tests/e2e/consultant-workflow.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Consultant Workflow', () => {
         |      ^
       9 |   test.skip('Consultant workflow: Assign client → View client data → Generate client pack', async ({ page }) => {
      10 |     // This test requires:
      11 |     // 1. Consultant user account

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/consultant-workflow.test.ts:8:6)

Summary of all failing tests
FAIL tests/integration/api/pagination.test.ts (20.887 s)
  ● Pagination API › Companies Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      45 |       });
      46 |
    > 47 |       expect(response.status).toBe(200);
         |                               ^
      48 |       const data = await response.json();
      49 |       expect(data).toHaveProperty('pagination');
      50 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:47:31)

  ● Pagination API › Companies Pagination › should respect limit parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      63 |       });
      64 |
    > 65 |       expect(response.status).toBe(200);
         |                               ^
      66 |       const data = await response.json();
      67 |       expect(data.data.length).toBeLessThanOrEqual(5);
      68 |       expect(data.pagination.limit).toBe(5);

      at Object.toBe (tests/integration/api/pagination.test.ts:65:31)

  ● Pagination API › Companies Pagination › should handle cursor parameter

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      80 |       });
      81 |
    > 82 |       expect(firstResponse.status).toBe(200);
         |                                    ^
      83 |       const firstData = await firstResponse.json();
      84 |
      85 |       if (firstData.pagination?.cursor) {

      at Object.toBe (tests/integration/api/pagination.test.ts:82:36)

  ● Pagination API › Companies Pagination › should enforce max limit of 100

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      105 |       });
      106 |
    > 107 |       expect(response.status).toBe(200);
          |                               ^
      108 |       const data = await response.json();
      109 |       expect(data.pagination.limit).toBeLessThanOrEqual(100);
      110 |     });

      at Object.toBe (tests/integration/api/pagination.test.ts:107:31)

  ● Pagination API › Sites Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      123 |       });
      124 |
    > 125 |       expect(response.status).toBe(200);
          |                               ^
      126 |       const data = await response.json();
      127 |       expect(data).toHaveProperty('pagination');
      128 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:125:31)

  ● Pagination API › Evidence Pagination › should return pagination object

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      163 |       });
      164 |
    > 165 |       expect(response.status).toBe(200);
          |                               ^
      166 |       const data = await response.json();
      167 |       expect(data).toHaveProperty('pagination');
      168 |       expect(data.pagination).toHaveProperty('limit');

      at Object.toBe (tests/integration/api/pagination.test.ts:165:31)

FAIL tests/comprehensive/phase-2-api-comprehensive.test.ts (14.493 s)
  ● Phase 2: API Layer - Comprehensive Tests › 2.1: Authentication Endpoints › POST /api/v1/auth/login › should return token for valid credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      130 |         });
      131 |
    > 132 |         expect(response.status).toBe(200);
          |                                 ^
      133 |         const data = await response.json();
      134 |         expect(data.data).toHaveProperty('access_token');
      135 |         expect(data.data).toHaveProperty('refresh_token');

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:132:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.1: Authentication Endpoints › GET /api/v1/auth/me › should return user info with valid token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      160 |         });
      161 |
    > 162 |         expect(response.status).toBe(200);
          |                                 ^
      163 |         const data = await response.json();
      164 |         expect(data.data).toHaveProperty('id');
      165 |         expect(data.data).toHaveProperty('email', testUser.email);

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:162:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › GET /api/v1/companies › should return user company with valid token

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      189 |         });
      190 |
    > 191 |         expect(response.status).toBe(200);
          |                                 ^
      192 |         const data = await response.json();
      193 |         expect(data.data).toBeDefined();
      194 |       });

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:191:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › GET /api/v1/sites › should return sites for user company

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      206 |         });
      207 |
    > 208 |         expect(response.status).toBe(200);
          |                                 ^
      209 |         const data = await response.json();
      210 |         expect(Array.isArray(data.data)).toBe(true);
      211 |       });

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:208:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.2: Core Entity Endpoints › POST /api/v1/sites › should create site with valid data

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

      233 |         );
      234 |
    > 235 |         expect(response.status).toBe(201);
          |                                 ^
      236 |         const data = await response.json();
      237 |         expect(data.data).toHaveProperty('id');
      238 |         testSite.id = data.data.id;

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:235:33)

  ● Phase 2: API Layer - Comprehensive Tests › 2.3: Document Endpoints › should reject document upload without token

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 405

      276 |       // Note: Actual file upload test would need FormData
      277 |       const response = await client.post('/api/v1/documents/upload', {});
    > 278 |       expect(response.status).toBe(401);
          |                               ^
      279 |     });
      280 |   });
      281 |

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:278:31)

  ● Phase 2: API Layer - Comprehensive Tests › 2.5: RLS Enforcement › should prevent User A from seeing User B data

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [403, 404]

      347 |
      348 |       // Should fail (403 or 404) - User A cannot see User B's company
    > 349 |       expect([403, 404]).toContain(response.status);
          |                          ^
      350 |     });
      351 |   });
      352 |

      at Object.toContain (tests/comprehensive/phase-2-api-comprehensive.test.ts:349:26)

  ● Phase 2: API Layer - Comprehensive Tests › 2.6: Rate Limiting › should enforce rate limits

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      373 |
      374 |       // Accept either all OK or some rate limited (if rate limiting is working)
    > 375 |       expect(allOk || someRateLimited).toBe(true);
          |                                        ^
      376 |     });
      377 |   });
      378 |

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:375:40)

  ● Phase 2: API Layer - Comprehensive Tests › 2.7: Error Handling › should return 404 for non-existent resource

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      392 |
      393 |         // Should be 404 (not found) or 401 (unauthorized if token invalid)
    > 394 |         expect([404, 401].includes(response.status)).toBe(true);
          |                                                      ^
      395 |       });
      396 |
      397 |     it('should return 400 for invalid input', async () => {

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:394:54)

  ● Phase 2: API Layer - Comprehensive Tests › 2.7: Error Handling › should return standard error format

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      424 |
      425 |         // Should be 404 (not found) or 401 (unauthorized if token invalid)
    > 426 |         expect([404, 401].includes(response.status)).toBe(true);
          |                                                      ^
      427 |         const data = await response.json();
      428 |         expect(data.error).toBeDefined();
      429 |         expect(data.error).toHaveProperty('code');

      at Object.toBe (tests/comprehensive/phase-2-api-comprehensive.test.ts:426:54)

FAIL tests/integration/api/rls-enforcement.test.ts (22.03 s)
  ● RLS Enforcement via API › Companies RLS › should only return User A's company

    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      11 |   let userB: { email: string; token?: string; company_id: string };
      12 |
    > 13 |   beforeEach(async () => {
         |   ^
      14 |     // Create User A in Company A
      15 |     userA = await client.signup(
      16 |       `user_a_${Date.now()}@example.com`,

      at beforeEach (tests/integration/api/rls-enforcement.test.ts:13:3)
      at Object.describe (tests/integration/api/rls-enforcement.test.ts:8:1)

  ● RLS Enforcement via API › Companies RLS › should only return User B's company

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      64 |       });
      65 |
    > 66 |       expect(response.status).toBe(200);
         |                               ^
      67 |       const data = await response.json();
      68 |       expect(Array.isArray(data.data)).toBe(true);
      69 |       

      at Object.toBe (tests/integration/api/rls-enforcement.test.ts:66:31)

  ● RLS Enforcement via API › Companies RLS › should prevent User A from seeing User B's company

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [401, 403, 404]

      82 |
      83 |       // Should return 401, 403, or 404 (unauthorized, forbidden, or not found)
    > 84 |       expect([401, 403, 404]).toContain(response.status);
         |                               ^
      85 |     });
      86 |   });
      87 |

      at Object.toContain (tests/integration/api/rls-enforcement.test.ts:84:31)

  ● RLS Enforcement via API › Sites RLS › should only return User A's sites

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"11e0ed18-6f11-4629-bfbe-e1fd1ebb2297","timestamp":"2025-11-30T15:46:46.186Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

  ● RLS Enforcement via API › Sites RLS › should prevent User A from accessing User B's site

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"989b3c46-33e6-4616-9ab6-4d3a947f6d3f","timestamp":"2025-11-30T15:46:49.811Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:22:13)

  ● RLS Enforcement via API › Users RLS › should only return users from User A's company (Owner/Admin only)

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"59c2d418-e9f2-426e-beae-474f2a06406b","timestamp":"2025-11-30T15:46:51.016Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

  ● RLS Enforcement via API › Users RLS › should prevent User A from accessing User B's user record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"31ca25ad-b0b4-4097-9180-b8803a3fad6b","timestamp":"2025-11-30T15:46:52.186Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rls-enforcement.test.ts:15:13)

FAIL tests/integration/api/documents.test.ts (8.439 s)
  ● Documents API › POST /api/v1/documents › should upload document with valid file

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"801e1a3d-40da-42bc-a389-6979cd9f6f98","timestamp":"2025-11-30T15:46:53.389Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › POST /api/v1/documents › should reject upload without file

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"6f834331-9366-4524-8ccb-e658080118fe","timestamp":"2025-11-30T15:46:54.541Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › POST /api/v1/documents › should reject upload without site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"cca52cb9-f903-4ec3-a2d3-f49ffb9fc036","timestamp":"2025-11-30T15:46:55.725Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › GET /api/v1/documents › should filter by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3bad0167-3b40-4c90-a08b-d57f74367f96","timestamp":"2025-11-30T15:46:59.499Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

  ● Documents API › GET /api/v1/documents/{id} › should return 404 for non-existent document

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"d098f684-8a3a-4006-ac19-144845ac7ddd","timestamp":"2025-11-30T15:47:00.630Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/documents.test.ts:13:25)

FAIL tests/integration/api/rate-limiting.test.ts
  ● Rate Limiting API › Rate Limit Headers › should include rate limit headers in response

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"0e81828e-a385-4a66-9132-47e960bc47db","timestamp":"2025-11-30T15:47:01.824Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Rate Limit Headers › should decrease remaining count

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"f1fddc69-f3d6-4171-ae83-d4f1abcab107","timestamp":"2025-11-30T15:47:03.012Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Rate Limit Enforcement › should eventually return 429 when limit exceeded

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"ec9af56b-441c-4ecc-82ce-d535b0ccf483","timestamp":"2025-11-30T15:47:04.172Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

  ● Rate Limiting API › Different Endpoint Limits › should have different limits for document upload

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"285d95fd-397a-4191-b272-acfdda9bae23","timestamp":"2025-11-30T15:47:05.343Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/rate-limiting.test.ts:13:25)

FAIL tests/integration/api/error-handling.test.ts
  ● Error Handling API › 403 Forbidden › should return 403 or 404 when accessing other company's data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"fe2c7ec7-ab19-4278-a0ca-4a47655cb1d4","timestamp":"2025-11-30T15:47:06.586Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/error-handling.test.ts:64:15)

  ● Error Handling API › 404 Not Found › should return 404 for non-existent obligation

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 400

      106 |       });
      107 |
    > 108 |       expect(response.status).toBe(404);
          |                               ^
      109 |       const data = await response.json();
      110 |       expect(data.error).toBeDefined();
      111 |       expect(data.error.code).toBe('NOT_FOUND');

      at Object.toBe (tests/integration/api/error-handling.test.ts:108:31)

  ● Error Handling API › 404 Not Found › should return 404 for non-existent document

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"1729bdc7-a555-4b7c-82bc-7016e40e73f8","timestamp":"2025-11-30T15:47:10.152Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/error-handling.test.ts:96:27)

FAIL tests/integration/api/module-3.test.ts
  ● Module 3 API Endpoints › Module Activation › should return 403 if Module 3 not activated

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should list generators

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should filter generators by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators › should include percentage calculations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should create a generator

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 400 for invalid generator_type

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/generators › should return 404 for invalid document_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators/{generatorId} › should get generator details

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/generators/{generatorId} › should return 404 for invalid generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › PUT /api/v1/module-3/generators/{generatorId} › should update generator

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should create a run-hour record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should calculate running totals correctly

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should return 400 for negative hours

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/run-hours › should return 404 for invalid generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should list run-hour records

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should filter run-hours by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours › should filter run-hours by date range

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/run-hours/{recordId} › should get run-hour record details

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › PUT /api/v1/module-3/run-hours/{recordId} › should update run-hour record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/stack-tests › should create a stack test

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/stack-tests › should return 400 for invalid compliance_status

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/stack-tests › should list stack tests

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/stack-tests › should filter stack tests by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/maintenance-records › should create a maintenance record

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/maintenance-records › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/maintenance-records › should list maintenance records

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/maintenance-records › should filter maintenance records by generator_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations › should list MCPD registrations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations › should filter registrations by site_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/mcpd-registrations/{registrationId} › should get registration details with generators

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › GET /api/v1/module-3/aer › should list AER documents

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should create AER document and queue generation

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should return 400 for missing required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › POST /api/v1/module-3/aer › should return 404 for invalid document_id

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should enforce RLS - users can only see their company data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should require authentication

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

  ● Module 3 API Endpoints › Authorization and RLS › should require appropriate role for mutations

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"3ee59634-ca89-4c58-958d-4800380200e0","timestamp":"2025-11-30T15:47:11.371Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/module-3.test.ts:27:12)

FAIL tests/integration/api/consultant.test.ts
  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should return consultant dashboard with aggregated data

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should return empty dashboard if no clients assigned

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/dashboard › should require CONSULTANT role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients › should return list of assigned clients

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients › should filter by status

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients/{clientId} › should return client details for assigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › GET /api/v1/consultant/clients/{clientId} › should return 403 for unassigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should generate pack for assigned client

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should reject Board Pack generation

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should require ACTIVE assignment

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/consultant/clients/{clientId}/packs › should validate required fields

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should assign consultant to company

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should assign consultant to company

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should require OWNER or ADMIN role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should require OWNER or ADMIN role

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate consultant exists

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate consultant exists

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate user is a consultant

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"949552f9-a2ab-43f7-ac31-ae5d36ec99bf","timestamp":"2025-11-30T15:47:14.866Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:28:30)

  ● Consultant Control Centre API › POST /api/v1/companies/{companyId}/consultants/assign › should validate user is a consultant

    Signup failed: {"error":{"code":"INTERNAL_ERROR","message":"Failed to create user account. Supabase error: Request rate limit reached","details":{"error":"Request rate limit reached","status":429}},"meta":{"request_id":"5d95078d-08f8-4986-90ca-97eab970f384","timestamp":"2025-11-30T15:47:16.023Z"}}

      90 |     if (!response.ok) {
      91 |       const error = await response.json();
    > 92 |       throw new Error(`Signup failed: ${JSON.stringify(error)}`);
         |             ^
      93 |     }
      94 |
      95 |     const data = await response.json();

      at TestClient.signup (tests/helpers/test-client.ts:92:13)
      at Object.<anonymous> (tests/integration/api/consultant.test.ts:355:27)

FAIL tests/comprehensive/phase-1-database-comprehensive.test.ts
  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all 36+ required tables

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      15 |         .eq('table_type', 'BASE TABLE');
      16 |
    > 17 |       expect(error).toBeNull();
         |                     ^
      18 |       expect(tables).toBeDefined();
      19 |       
      20 |       const tableNames = tables?.map(t => t.table_name) || [];

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:17:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all required columns in companies table

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.notifications'", "message": "Could not find the table 'public.information_schema.columns' in the schema cache"}

      64 |         .eq('table_name', 'companies');
      65 |
    > 66 |       expect(error).toBeNull();
         |                     ^
      67 |       const columnNames = columns?.map(c => c.column_name) || [];
      68 |       
      69 |       expect(columnNames).toContain('id');

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:66:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.1: Database Schema Validation › should have all required indexes

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      92 |       
      93 |       // Check for critical indexes
    > 94 |       expect(indexNames.some((name: string) => name.includes('companies_stripe'))).toBe(true);
         |                                                                                    ^
      95 |       expect(indexNames.some((name: string) => name.includes('users_company'))).toBe(true);
      96 |       expect(indexNames.some((name: string) => name.includes('sites_company'))).toBe(true);
      97 |       expect(indexNames.some((name: string) => name.includes('obligations_document'))).toBe(true);

      at Object.toBe (tests/comprehensive/phase-1-database-comprehensive.test.ts:94:84)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.3: RLS Policies › should have policies for SELECT, INSERT, UPDATE, DELETE on tenant tables

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.companies'", "message": "Could not find the table 'public.pg_policies' in the schema cache"}

      220 |         .eq('schemaname', 'public');
      221 |
    > 222 |       expect(error).toBeNull();
          |                     ^
      223 |       
      224 |       const companiesPolicies = policies?.filter((p: any) => p.tablename === 'companies') || [];
      225 |       

      at Object.toBeNull (tests/comprehensive/phase-1-database-comprehensive.test.ts:222:21)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.5: Seed Data › should have correct module prerequisites

    expect(received).toBe(expected) // Object.is equality

    Expected: undefined
    Received: "c24c3828-a6a2-4f56-88ea-e86be8706af4"

      333 |       
      334 |       // Module 2 and 3 should require Module 1
    > 335 |       expect(module2?.requires_module_id).toBe(module1?.id);
          |                                           ^
      336 |       expect(module3?.requires_module_id).toBe(module1?.id);
      337 |     });
      338 |   });

      at Object.toBe (tests/comprehensive/phase-1-database-comprehensive.test.ts:335:43)

  ● Phase 1: Database Foundation - Comprehensive Tests › 1.6: Helper Functions › should have RLS helper functions

    expect(received).not.toContain(expected) // indexOf

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

      349 |       // Function should exist (error would be function doesn't exist)
      350 |       // Result doesn't matter, just that function exists
    > 351 |       expect(error?.message).not.toContain('function');
          |                                  ^
      352 |     });
      353 |   });
      354 | });

      at Object.toContain (tests/comprehensive/phase-1-database-comprehensive.test.ts:351:34)

FAIL tests/security/rls-production.test.ts
  ● Production Security Audit › RLS Policies › RLS policies prevent cross-tenant access

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 422

      31 |       // Signup User 1
      32 |       const signup1Response = await client.post('/api/v1/auth/signup', user1);
    > 33 |       expect(signup1Response.status).toBe(201);
         |                                      ^
      34 |       const signup1Data = await signup1Response.json();
      35 |       const user1Token = signup1Data.data.access_token || signup1Data.data.token;
      36 |       

      at Object.toBe (tests/security/rls-production.test.ts:33:38)

  ● Production Security Audit › Authentication › JWT tokens cannot be tampered with

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 422

      104 |       
      105 |       const signupResponse = await client.post('/api/v1/auth/signup', testUser);
    > 106 |       expect(signupResponse.status).toBe(201);
          |                                     ^
      107 |       const signupData = await signupResponse.json();
      108 |       const validToken = signupData.data.access_token || signupData.data.token;
      109 |       

      at Object.toBe (tests/security/rls-production.test.ts:106:37)

  ● Production Security Audit › SQL Injection Prevention › SQL injection attempts are prevented

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 400, 404]

      163 |         
      164 |         // Should return 400 or 200 with filtered results (not execute SQL)
    > 165 |         expect([200, 400, 404]).toContain(response.status);
          |                                 ^
      166 |       }
      167 |     });
      168 |   });

      at Object.toContain (tests/security/rls-production.test.ts:165:33)

FAIL tests/integration/api/module-2.test.ts
  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should list parameters

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should filter parameters by site_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/parameters › should return 403 if Module 2 not activated

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should create a lab result

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should detect exceedance when limit exceeded

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should return 400 for missing required fields

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/lab-results › should return 404 for invalid parameter_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should list lab results

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should filter lab results by parameter_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results › should filter lab results by is_exceedance

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results/{resultId} › should get lab result details

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/lab-results/{resultId} › should return 400 or 404 for invalid resultId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should list exceedances

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should filter exceedances by threshold

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/exceedances › should include threshold_level in response

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents › should list consents

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents › should filter consents by site_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents/{consentId} › should get consent details with parameters

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/consents/{consentId} › should return 400 or 404 for invalid consentId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes › should list discharge volumes

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes › should filter discharge volumes by document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should create a discharge volume record

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should return 400 for missing required fields

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/discharge-volumes › should return 400 for negative volume

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes/{volumeId} › should get discharge volume details

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/discharge-volumes/{volumeId} › should return 400 or 404 for invalid volumeId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should queue report generation

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should return 400 for missing document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › POST /api/v1/module-2/water-company-reports › should return 404 for invalid document_id

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/water-company-reports/{reportId} › should get report status

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

  ● Module 2 API Endpoints › GET /api/v1/module-2/water-company-reports/{reportId} › should return 400 or 404 for invalid reportId

    Failed to create test site: {"error":{"code":"UNAUTHORIZED","message":"Invalid or expired token"},"meta":{"timestamp":"2025-11-30T15:47:22.315Z"}}

      103 |       const errorText = await siteResponse.text();
      104 |       console.error('Site creation failed:', errorText);
    > 105 |       throw new Error(`Failed to create test site: ${errorText}`);
          |             ^
      106 |     }
      107 |     
      108 |     const siteData = await siteResponse.json();

      at Object.<anonymous> (tests/integration/api/module-2.test.ts:105:13)

FAIL tests/integration/jobs/excel-import.test.ts
  ● Excel Import Processing Job › should validate Excel file and create preview (Phase 1)

    Failed to upload test Excel: mime type application/octet-stream is not supported

      103 |
      104 |     if (uploadError) {
    > 105 |       throw new Error(`Failed to upload test Excel: ${uploadError.message}`);
          |             ^
      106 |     }
      107 |
      108 |     // Create excel_imports record

      at Object.<anonymous> (tests/integration/jobs/excel-import.test.ts:105:13)

FAIL tests/integration/jobs/deadline-alert.test.ts
  ● Deadline Alert Job › should create notifications for deadlines due in 7/3/1 days

    Failed to create test obligation: null value in column "document_id" of relation "obligations" violates not-null constraint

      94 |
      95 |     if (obligError || !obligation) {
    > 96 |       throw new Error(`Failed to create test obligation: ${obligError?.message}`);
         |             ^
      97 |     }
      98 |
      99 |     // Create deadline due in 7 days

      at Object.<anonymous> (tests/integration/jobs/deadline-alert.test.ts:96:13)

FAIL tests/integration/jobs/monitoring-schedule.test.ts
  ● Monitoring Schedule Job › should calculate deadlines for obligations with frequency

    Failed to create test obligation: null value in column "document_id" of relation "obligations" violates not-null constraint

       96 |
       97 |     if (obligError || !obligation) {
    >  98 |       throw new Error(`Failed to create test obligation: ${obligError?.message}`);
          |             ^
       99 |     }
      100 |
      101 |     // Enqueue job

      at Object.<anonymous> (tests/integration/jobs/monitoring-schedule.test.ts:98:13)

FAIL tests/comprehensive/phase-4-jobs-comprehensive.test.ts
  ● Phase 4: Background Jobs - Comprehensive Tests › 4.1: Queue Manager › should have queue manager configured

    expect(received).toBeDefined()

    Received: undefined

       9 |   describe('4.1: Queue Manager', () => {
      10 |     it('should have queue manager configured', () => {
    > 11 |       expect(QueueManager).toBeDefined();
         |                            ^
      12 |     });
      13 |
      14 |     it('should have all required queues', () => {

      at Object.toBeDefined (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:11:28)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.1: Queue Manager › should have all required queues

    expect(received).toBeDefined()

    Received: undefined

      35 |
      36 |       // Verify queue manager can handle these queues
    > 37 |       expect(QueueManager).toBeDefined();
         |                            ^
      38 |     });
      39 |   });
      40 |

      at Object.toBeDefined (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:37:28)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.2: Job Types › should have document processing job

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at tests/comprehensive/phase-4-jobs-comprehensive.test.ts:43:44
      at Object.<anonymous> (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:43:38)

  ● Phase 4: Background Jobs - Comprehensive Tests › 4.3: Worker System › should have worker manager configured

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at Object.<anonymous> (lib/workers/worker-manager.ts:28:32)
      at tests/comprehensive/phase-4-jobs-comprehensive.test.ts:70:57
      at Object.<anonymous> (tests/comprehensive/phase-4-jobs-comprehensive.test.ts:70:51)

FAIL tests/integration/jobs/pack-generation.test.ts
  ● Pack Generation Job › should generate an audit pack PDF

    Failed to create test pack: Could not find the 'status' column of 'audit_packs' in the schema cache

      64 |
      65 |     if (packError || !pack) {
    > 66 |       throw new Error(`Failed to create test pack: ${packError?.message}`);
         |             ^
      67 |     }
      68 |
      69 |     // Enqueue job

      at Object.<anonymous> (tests/integration/jobs/pack-generation.test.ts:66:13)

FAIL tests/frontend/components/button.test.tsx
  ● Button Component › should render button with text

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

       9 | describe('Button Component', () => {
      10 |   it('should render button with text', () => {
    > 11 |     render(<Button>Click me</Button>);
         |           ^
      12 |     expect(screen.getByRole('button', { name: /click me/i })).toBeInTheDocument();
      13 |   });
      14 |

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:11:11)

  ● Button Component › should render button with text

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should handle click events

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      15 |   it('should handle click events', async () => {
      16 |     const handleClick = jest.fn();
    > 17 |     const user = userEvent.setup();
         |                            ^
      18 |     
      19 |     render(<Button onClick={handleClick}>Click me</Button>);
      20 |     

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/components/button.test.tsx:17:28)

  ● Button Component › should handle click events

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should be disabled when disabled prop is true

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      26 |
      27 |   it('should be disabled when disabled prop is true', () => {
    > 28 |     render(<Button disabled>Disabled Button</Button>);
         |           ^
      29 |     
      30 |     const button = screen.getByRole('button', { name: /disabled button/i });
      31 |     expect(button).toBeDisabled();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:28:11)

  ● Button Component › should be disabled when disabled prop is true

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should apply primary variant styles

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      33 |
      34 |   it('should apply primary variant styles', () => {
    > 35 |     render(<Button variant="primary">Primary</Button>);
         |           ^
      36 |     
      37 |     const button = screen.getByRole('button', { name: /primary/i });
      38 |     expect(button).toHaveClass('bg-primary');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:35:11)

  ● Button Component › should apply primary variant styles

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Button Component › should apply danger variant styles

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      40 |
      41 |   it('should apply danger variant styles', () => {
    > 42 |     render(<Button variant="danger">Danger</Button>);
         |           ^
      43 |     
      44 |     const button = screen.getByRole('button', { name: /danger/i });
      45 |     expect(button).toHaveClass('bg-danger');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/components/button.test.tsx:42:11)

  ● Button Component › should apply danger variant styles

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at detachClipboardStubFromView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:122:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:161:20)

FAIL tests/comprehensive/phase-3-ai-comprehensive.test.ts
  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.2: Rule Library Integration › should have rule library patterns in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": "Perhaps you meant the table 'public.module_activations'", "message": "Could not find the table 'public.rule_library_patterns' in the schema cache"}

      28 |
      29 |       // Patterns may or may not exist - this is OK
    > 30 |       expect(error).toBeNull();
         |                     ^
      31 |     });
      32 |
      33 |     it('should have pattern matching function', async () => {

      at Object.toBeNull (tests/comprehensive/phase-3-ai-comprehensive.test.ts:30:21)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.3: Document Processing › should have document processor configured

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      40 |   describe('3.3: Document Processing', () => {
      41 |     it('should have document processor configured', async () => {
    > 42 |       const { DocumentProcessor } = await import('../../lib/ai/document-processor');
         |                                           ^
      43 |       expect(DocumentProcessor).toBeDefined();
      44 |     });
      45 |

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at tests/comprehensive/phase-3-ai-comprehensive.test.ts:42:43
      at Object.<anonymous> (tests/comprehensive/phase-3-ai-comprehensive.test.ts:42:37)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.5: Cost Tracking › should have cost calculator configured

    expect(received).toBeDefined()

    Received: undefined

      61 |     it('should have cost calculator configured', async () => {
      62 |       const { CostCalculator } = await import('../../lib/ai/cost-calculator');
    > 63 |       expect(CostCalculator).toBeDefined();
         |                              ^
      64 |     });
      65 |
      66 |     it('should track extraction costs in database', async () => {

      at Object.toBeDefined (tests/comprehensive/phase-3-ai-comprehensive.test.ts:63:30)

  ● Phase 3: AI/Extraction Layer - Comprehensive Tests › 3.5: Cost Tracking › should track extraction costs in database

    expect(received).toBeNull()

    Received: {"code": "42703", "details": null, "hint": null, "message": "column extraction_logs.cost_per_1k_tokens does not exist"}

      71 |
      72 |       // Logs may or may not exist - this is OK
    > 73 |       expect(error).toBeNull();
         |                     ^
      74 |     });
      75 |   });
      76 | });

      at Object.toBeNull (tests/comprehensive/phase-3-ai-comprehensive.test.ts:73:21)

FAIL tests/frontend/dashboard/obligations-list.test.tsx
  ● Obligations List Page › should render obligations list page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      39 |     });
      40 |
    > 41 |     render(<ObligationsPage />);
         |           ^
      42 |     
      43 |     expect(screen.getByText('Obligations')).toBeInTheDocument();
      44 |     expect(screen.getByText(/track and manage your compliance obligations/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:41:11)

  ● Obligations List Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      52 |     });
      53 |
    > 54 |     render(<ObligationsPage />);
         |           ^
      55 |     
      56 |     expect(screen.getByText(/loading obligations/i)).toBeInTheDocument();
      57 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:54:11)

  ● Obligations List Page › should show empty state when no obligations

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      64 |     });
      65 |
    > 66 |     render(<ObligationsPage />);
         |           ^
      67 |     
      68 |     expect(screen.getByText(/no obligations found/i)).toBeInTheDocument();
      69 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:66:11)

  ● Obligations List Page › should render obligations table when data exists

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      89 |     });
      90 |
    > 91 |     render(<ObligationsPage />);
         |           ^
      92 |     
      93 |     expect(screen.getByText('Test Obligation')).toBeInTheDocument();
      94 |     expect(screen.getByText('Obligation')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:91:11)

  ● Obligations List Page › should show error state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      104 |     });
      105 |
    > 106 |     render(<ObligationsPage />);
          |           ^
      107 |     
      108 |     expect(screen.getByText(/error loading obligations/i)).toBeInTheDocument();
      109 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/obligations-list.test.tsx:106:11)

FAIL tests/comprehensive/phase-8-modules-comprehensive.test.ts
  ● Phase 8: Module Extensions - Comprehensive Tests › 8.1: Module 2 - Trade Effluent › should have Module 2 tables in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      23 |
      24 |       // At least some Module 2 tables should exist
    > 25 |       expect(error).toBeNull();
         |                     ^
      26 |     });
      27 |
      28 |     it('should have Module 2 API endpoints', () => {

      at Object.toBeNull (tests/comprehensive/phase-8-modules-comprehensive.test.ts:25:21)

  ● Phase 8: Module Extensions - Comprehensive Tests › 8.2: Module 3 - MCPD/Generators › should have Module 3 tables in database

    expect(received).toBeNull()

    Received: {"code": "PGRST205", "details": null, "hint": null, "message": "Could not find the table 'public.information_schema.tables' in the schema cache"}

      63 |
      64 |       // At least some Module 3 tables should exist
    > 65 |       expect(error).toBeNull();
         |                     ^
      66 |     });
      67 |
      68 |     it('should have Module 3 API endpoints', () => {

      at Object.toBeNull (tests/comprehensive/phase-8-modules-comprehensive.test.ts:65:21)

FAIL tests/frontend/auth/login.test.tsx
  ● Login Page › should render login form

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      38 |
      39 |   it('should render login form', () => {
    > 40 |     render(<LoginPage />);
         |           ^
      41 |     
      42 |     expect(screen.getByText('EcoComply')).toBeInTheDocument();
      43 |     expect(screen.getByText('Sign in to your account')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/login.test.tsx:40:11)

  ● Login Page › should render login form

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should show validation error for empty email

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      48 |
      49 |   it('should show validation error for empty email', async () => {
    > 50 |     const user = userEvent.setup();
         |                            ^
      51 |     render(<LoginPage />);
      52 |     
      53 |     const submitButton = screen.getByRole('button', { name: /sign in/i });

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/auth/login.test.tsx:50:28)

  ● Login Page › should show validation error for empty email

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should show validation error for empty password

    TypeError: Cannot read properties of undefined (reading 'Symbol(Node prepared with document state workarounds)')

      60 |
      61 |   it('should show validation error for empty password', async () => {
    > 62 |     const user = userEvent.setup();
         |                            ^
      63 |     render(<LoginPage />);
      64 |     
      65 |     const emailInput = screen.getByLabelText('Email');

      at Object.prepareDocument (node_modules/@testing-library/user-event/dist/cjs/document/prepareDocument.js:12:17)
      at Object.setupMain [as setup] (node_modules/@testing-library/user-event/dist/cjs/setup/setup.js:54:21)
      at Object.setup (tests/frontend/auth/login.test.tsx:62:28)

  ● Login Page › should show validation error for empty password

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)

  ● Login Page › should have link to signup page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      75 |
      76 |   it('should have link to signup page', () => {
    > 77 |     render(<LoginPage />);
         |           ^
      78 |     
      79 |     const signupLink = screen.getByRole('link', { name: /sign up/i });
      80 |     expect(signupLink).toHaveAttribute('href', '/signup');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/login.test.tsx:77:11)

  ● Login Page › should have link to signup page

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at resetClipboardStubOnView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:117:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:158:21)


  ● Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'navigator')

      at detachClipboardStubFromView (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:122:32)
      at Object.<anonymous> (node_modules/@testing-library/user-event/dist/cjs/utils/dataTransfer/Clipboard.js:161:20)

FAIL tests/frontend/auth/signup.test.tsx
  ● Signup Page › should render signup form

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      37 |
      38 |   it('should render signup form', () => {
    > 39 |     render(<SignupPage />);
         |           ^
      40 |     
      41 |     expect(screen.getByRole('heading', { name: /create account/i })).toBeInTheDocument();
      42 |     expect(screen.getByText('Get started with EcoComply')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:39:11)

  ● Signup Page › should show password requirements

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      50 |
      51 |   it('should show password requirements', () => {
    > 52 |     render(<SignupPage />);
         |           ^
      53 |     
      54 |     expect(screen.getByText(/must be at least 8 characters/i)).toBeInTheDocument();
      55 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:52:11)

  ● Signup Page › should have link to login page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      56 |
      57 |   it('should have link to login page', () => {
    > 58 |     render(<SignupPage />);
         |           ^
      59 |     
      60 |     const loginLink = screen.getByRole('link', { name: /sign in/i });
      61 |     expect(loginLink).toHaveAttribute('href', '/login');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/auth/signup.test.tsx:58:11)

FAIL tests/frontend/dashboard/documents-list.test.tsx
  ● Documents List Page › should render documents list page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      39 |     });
      40 |
    > 41 |     render(<DocumentsPage />);
         |           ^
      42 |     
      43 |     expect(screen.getByText('Documents')).toBeInTheDocument();
      44 |     expect(screen.getByText(/manage your environmental compliance documents/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:41:11)

  ● Documents List Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      52 |     });
      53 |
    > 54 |     render(<DocumentsPage />);
         |           ^
      55 |     
      56 |     expect(screen.getByText(/loading documents/i)).toBeInTheDocument();
      57 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:54:11)

  ● Documents List Page › should show empty state when no documents

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      64 |     });
      65 |
    > 66 |     render(<DocumentsPage />);
         |           ^
      67 |     
      68 |     expect(screen.getByText(/no documents found/i)).toBeInTheDocument();
      69 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:66:11)

  ● Documents List Page › should render documents table when data exists

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      88 |     });
      89 |
    > 90 |     render(<DocumentsPage />);
         |           ^
      91 |     
      92 |     expect(screen.getByText('Test Document')).toBeInTheDocument();
      93 |     expect(screen.getByText('Document Name')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:90:11)

  ● Documents List Page › should show error state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      104 |     });
      105 |
    > 106 |     render(<DocumentsPage />);
          |           ^
      107 |     
      108 |     expect(screen.getByText(/error loading documents/i)).toBeInTheDocument();
      109 |   });

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:106:11)

  ● Documents List Page › should have upload button

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      116 |     });
      117 |
    > 118 |     render(<DocumentsPage />);
          |           ^
      119 |     
      120 |     const uploadLink = screen.getByRole('link', { name: /upload document/i });
      121 |     expect(uploadLink).toHaveAttribute('href', '/dashboard/documents/upload');

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/documents-list.test.tsx:118:11)

FAIL tests/frontend/dashboard/dashboard-home.test.tsx
  ● Dashboard Home Page › should render dashboard home page

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      43 |       });
      44 |
    > 45 |     render(<DashboardPage />);
         |           ^
      46 |     
      47 |     expect(screen.getByText('Dashboard')).toBeInTheDocument();
      48 |     expect(screen.getByText(/welcome back/i)).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:45:11)

  ● Dashboard Home Page › should show stats cards

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      65 |       });
      66 |
    > 67 |     render(<DashboardPage />);
         |           ^
      68 |     
      69 |     expect(screen.getByText('Total Obligations')).toBeInTheDocument();
      70 |     expect(screen.getByText('Overdue')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:67:11)

  ● Dashboard Home Page › should show loading state

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      84 |       });
      85 |
    > 86 |     render(<DashboardPage />);
         |           ^
      87 |     
      88 |     // Loading states are shown via skeleton/placeholder
      89 |     expect(screen.getByText('Dashboard')).toBeInTheDocument();

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/dashboard-home.test.tsx:86:11)

FAIL tests/frontend/dashboard/layout.test.tsx
  ● Dashboard Layout › should redirect to login if not authenticated

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      42 |     mockIsAuthenticated.mockReturnValue(false);
      43 |     
    > 44 |     render(
         |           ^
      45 |       <DashboardLayout>
      46 |         <div>Test Content</div>
      47 |       </DashboardLayout>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/layout.test.tsx:44:11)

  ● Dashboard Layout › should render layout when authenticated

    The error below may be caused by using the wrong test environment, see https://jestjs.io/docs/configuration#testenvironment-string.
    Consider using the "jsdom" test environment.

    ReferenceError: document is not defined

      54 |     mockIsAuthenticated.mockReturnValue(true);
      55 |     
    > 56 |     render(
         |           ^
      57 |       <DashboardLayout>
      58 |         <div data-testid="content">Test Content</div>
      59 |       </DashboardLayout>

      at render (node_modules/@testing-library/react/dist/pure.js:257:5)
      at Object.<anonymous> (tests/frontend/dashboard/layout.test.tsx:56:11)

FAIL tests/integration/jobs/document-processing.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      13 | import { checkForPatternDiscovery } from '@/lib/ai/pattern-discovery';
      14 | import { calculateCost } from '@/lib/ai/cost-calculator';
    > 15 |
         | ^
      16 | export interface DocumentProcessingJobData {
      17 |   document_id: string;
      18 |   company_id: string;

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (lib/jobs/document-processing-job.ts:15:28)
      at Object.<anonymous> (tests/integration/jobs/document-processing.test.ts:10:32)

FAIL tests/integration/api/auth.test.ts
  ● Test suite failed to run

      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:252:1]
     [2m249[0m |       await new Promise(resolve => setTimeout(resolve, 2000));
     [2m250[0m |     }, 15000); // Increase timeout to 15 seconds
     [2m251[0m |       
     [2m252[0m |       const loginResponse = await client.post('/api/v1/auth/login', {
         : [35;1m                            ^^^^^[0m
     [2m253[0m |         email: authenticatedUser.email,
     [2m254[0m |         password: 'TestPassword123!',
     [2m255[0m |       });
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:258:1]
     [2m255[0m |       });
     [2m256[0m |       
     [2m257[0m |       if (loginResponse.ok) {
     [2m258[0m |         const loginData = await loginResponse.json();
         : [35;1m                          ^^^^^[0m
     [2m259[0m |         authenticatedUser.refreshToken = loginData.data?.refresh_token;
     [2m260[0m |         authenticatedUser.token = loginData.data?.access_token || authenticatedUser.token;
     [2m261[0m |       } else {
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:264:1]
     [2m261[0m |       } else {
     [2m262[0m |         // If login fails, try to get refresh token from signup response
     [2m263[0m |         // Signup might have returned tokens if email verification is disabled
     [2m264[0m |         const signupResponse = await client.post('/api/v1/auth/signup', {
         : [35;1m                               ^^^^^[0m
     [2m265[0m |           email: `test_refresh_${Date.now()}@example.com`,
     [2m266[0m |           password: 'TestPassword123!',
     [2m267[0m |           full_name: 'Test User',
         `----
      [31mx[0m await isn't allowed in non-async function
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:271:1]
     [2m268[0m |           company_name: 'Test Company',
     [2m269[0m |         });
     [2m270[0m |         if (signupResponse.ok) {
     [2m271[0m |           const signupData = await signupResponse.json();
         : [35;1m                             ^^^^^[0m
     [2m272[0m |           authenticatedUser.refreshToken = signupData.data?.refresh_token;
     [2m273[0m |           authenticatedUser.token = signupData.data?.access_token;
     [2m274[0m |         }
         `----
      [31mx[0m Expression expected
         ,-[[36;1;4m/Users/waqaar/Documents/Oblicore/tests/integration/api/auth.test.ts[0m:359:1]
     [2m356[0m |       expect(data.data).toHaveProperty('message');
     [2m357[0m |     });
     [2m358[0m |   });
     [2m359[0m | });
         : [35;1m^[0m
     [2m360[0m | 
         `----


    Caused by:
        Syntax Error

      at Object.transformSync (node_modules/next/src/build/swc/index.ts:1444:25)
      at transformSync (node_modules/next/src/build/swc/index.ts:1575:19)
      at Object.process (node_modules/next/src/build/swc/jest-transformer.ts:105:25)
      at ScriptTransformer.transformSource (node_modules/@jest/transform/build/index.js:422:31)
      at ScriptTransformer._transformAndBuildScript (node_modules/@jest/transform/build/index.js:519:40)
      at ScriptTransformer.transform (node_modules/@jest/transform/build/index.js:558:19)

FAIL tests/integration/ai/phase3-end-to-end.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

      10 | import { getDocumentProcessor } from '@/lib/ai/document-processor';
      11 | import { getObligationCreator } from '@/lib/ai/obligation-creator';
    > 12 | import { getPromptTemplate } from '@/lib/ai/prompts';
         |                            ^
      13 |
      14 | describe('Phase 3: End-to-End AI/Extraction Pipeline', () => {
      15 |   const apiKeyManager = getAPIKeyManager();

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (tests/integration/ai/phase3-end-to-end.test.ts:12:28)

FAIL tests/integration/ai/phase3-3-document-processing.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/lib/ai/document-processor.ts:265
            const documentType = options.documentType || 'ENVIRONMENTAL_PERMIT';
                  ^

    SyntaxError: Identifier 'documentType' has already been declared

       7 | import { getDocumentProcessor } from '@/lib/ai/document-processor';
       8 | import { getObligationCreator } from '@/lib/ai/obligation-creator';
    >  9 | import { createClient } from '@supabase/supabase-js';
         |                            ^
      10 | import { env } from '@/lib/env';
      11 |
      12 | describe('Phase 3.3: Document Processing Pipeline', () => {

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)
      at Object.<anonymous> (tests/integration/ai/phase3-3-document-processing.test.ts:9:28)

FAIL tests/frontend/dashboard/documents-upload.test.tsx
  ● Test suite failed to run

    ReferenceError: TextEncoder is not defined

      1 | // Polyfill fetch for Node.js test environment
      2 | if (typeof globalThis.fetch === 'undefined') {
    > 3 |   const { fetch, Request, Response, Headers } = require('undici');
        |                                                 ^
      4 |   globalThis.fetch = fetch;
      5 |   globalThis.Request = Request;
      6 |   globalThis.Response = Response;

      at Object.<anonymous> (node_modules/undici/lib/web/fetch/data-url.js:5:17)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/util.js:7:97)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/headers.js:11:5)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/response.js:3:90)
      at Object.<anonymous> (node_modules/undici/lib/web/fetch/index.js:12:5)
      at Object.<anonymous> (node_modules/undici/index.js:119:19)
      at Object.require (jest.setup.js:3:49)

FAIL tests/performance/page-load.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Page Load Performance', () => {
         |      ^
       9 |   const baseURL = process.env.BASE_URL || 'http://localhost:3000';
      10 |
      11 |   test('Page load times < 3s for all pages', async ({ page }) => {

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/performance/page-load.test.ts:8:6)

FAIL tests/performance/api-benchmark.test.ts
  ● Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation, specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/waqaar/Documents/Oblicore/tests/performance/api-benchmark.test.ts:11
        const client = new _testclient.TestClient();
              ^

    SyntaxError: Identifier 'client' has already been declared

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1318:40)

FAIL tests/e2e/user-journey.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Complete User Journey', () => {
         |      ^
       9 |   const timestamp = Date.now();
      10 |   const testUser = {
      11 |     email: `e2e_test_${timestamp}@example.com`,

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/user-journey.test.ts:8:6)

FAIL tests/e2e/production-readiness.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       7 | import { TestClient } from '../helpers/test-client';
       8 |
    >  9 | test.describe('Production Readiness', () => {
         |      ^
      10 |   const client = new TestClient();
      11 |   const baseURL = process.env.BASE_URL || 'http://localhost:3000';
      12 |

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/production-readiness.test.ts:9:6)

FAIL tests/e2e/consultant-workflow.test.ts
  ● Test suite failed to run

    Playwright Test needs to be invoked via 'npx playwright test' and excluded from Jest test runs.
    Creating one directory for Playwright tests and one for Jest is the recommended way of doing it.
    See https://playwright.dev/docs/intro for more information about Playwright Test.

       6 | import { test, expect } from '@playwright/test';
       7 |
    >  8 | test.describe('Consultant Workflow', () => {
         |      ^
       9 |   test.skip('Consultant workflow: Assign client → View client data → Generate client pack', async ({ page }) => {
      10 |     // This test requires:
      11 |     // 1. Consultant user account

      at throwIfRunningInsideJest (node_modules/playwright/lib/common/testType.js:273:11)
      at TestTypeImpl._describe (node_modules/playwright/lib/common/testType.js:114:5)
      at Function.describe (node_modules/playwright/lib/transform/transform.js:275:12)
      at Object.describe (tests/e2e/consultant-workflow.test.ts:8:6)


Test Suites: 35 failed, 8 passed, 43 total
Tests:       170 failed, 7 skipped, 97 passed, 274 total
Snapshots:   0 total
Time:        106.783 s, estimated 188 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
